package com.example.demo.controller;

import java.io.File;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Map;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import com.example.demo.dto.ApplicationDto;
import com.example.demo.model.ApplicationModel;
import com.example.demo.service.ApplicationService;

@CrossOrigin("http://localhost:5173")
@RestController
@RequestMapping("/applications")
public class ApplicationController {

	@Autowired
	private ApplicationService service;

	// ⭐⭐⭐ APPLICATION SUBMIT (JSON + Aadhaar File Upload)
	@PostMapping("/apply")
	public ApplicationModel apply(@ModelAttribute ApplicationDto dto,
			@RequestParam("aadhaarFile") MultipartFile aadhaarFile) {

		try {
			// Save file
			String uploadDir = "uploads/aadhaar/";
			File folder = new File(uploadDir);
			if (!folder.exists())
				folder.mkdirs();

			String fileName = System.currentTimeMillis() + "_" + aadhaarFile.getOriginalFilename();
			Path filePath = Paths.get(uploadDir + fileName);
			Files.write(filePath, aadhaarFile.getBytes());

			// Convert DTO → Model
			ApplicationModel app = new ApplicationModel();
			app.setCertificateType(dto.getCertificateType());
			app.setTamilCertificateType(dto.getTamilCertificateType());
			app.setFullName(dto.getFullName());
			app.setFatherName(dto.getFatherName());
			app.setMotherName(dto.getMotherName());
			app.setDob(dto.getDob());
			app.setGender(dto.getGender());
			app.setAddress(dto.getAddress());
			app.setDistrict(dto.getDistrict());
			app.setTaluk(dto.getTaluk());
			app.setMobile(dto.getMobile());
			app.setEmail(dto.getEmail());
			app.setAppliedDate(dto.getAppliedDate());
			app.setStatus(dto.getStatus());
			app.setAadhaar(fileName);

			return service.apply(app);

		} catch (Exception e) {
			throw new RuntimeException(e.getMessage());
		}
	}

	// ⭐ TRACK APPLICATION BY EMAIL
	@GetMapping("/track/email/{email}")
	public List<ApplicationModel> getByEmail(@PathVariable String email) {
		return service.getByEmail(email);
	}

	// ⭐ ADMIN — VIEW ALL
	@GetMapping("/admin")
	public List<ApplicationModel> getAll() {
		return service.getAllApplications();
	}

	// ⭐ UPDATE APPLICATION STATUS
	@PutMapping("/status/{id}")
	public ApplicationModel updateStatus(@PathVariable Long id, @RequestParam String status) {
		return service.updateStatus(id, status);
	}

	// ⭐ GET SINGLE APP BY ID
	@GetMapping("/{id}")
	public ApplicationModel getById(@PathVariable Long id) {
		return service.getById(id);
	}

	// ⭐ DELETE APPLICATION
	@DeleteMapping("/delete/{id}")
	public String deleteApplication(@PathVariable Long id) {
		boolean deleted = service.delete(id);
		return deleted ? "Application Deleted Successfully" : "Application Not Found";
	}
}
