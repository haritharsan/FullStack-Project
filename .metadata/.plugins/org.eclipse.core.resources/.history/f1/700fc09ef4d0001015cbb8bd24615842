package com.example.demo.controller;

import java.io.File;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Map;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import com.example.demo.model.ApplicationModel;
import com.example.demo.service.ApplicationService;

@CrossOrigin("http://localhost:5173")
@RestController
@RequestMapping("/applications")
public class ApplicationController {

    @Autowired
    private ApplicationService service;

    // ⭐⭐⭐ APPLICATION SUBMIT (JSON + Aadhaar File Upload)
    @PostMapping("/apply")
    public ApplicationModel apply(
            @RequestPart("aadhaarFile") MultipartFile aadhaarFile,
            @RequestPart Map<String, String> data) {

        try {
            // -----------------------------------------------------------
            // 1️⃣ SAVE FILE IN BACKEND FOLDER
            // -----------------------------------------------------------
            String uploadDir = "uploads/aadhaar/";
            File folder = new File(uploadDir);
            if (!folder.exists()) folder.mkdirs();

            String fileName = System.currentTimeMillis() + "_" + aadhaarFile.getOriginalFilename();
            Path filePath = Paths.get(uploadDir + fileName);
            Files.write(filePath, aadhaarFile.getBytes());

            // -----------------------------------------------------------
            // 2️⃣ MAP JSON → ApplicationModel
            // -----------------------------------------------------------
            ApplicationModel app = new ApplicationModel();

            app.setCertificateType(data.get("certificateType"));
            app.setTamilCertificateType(data.get("tamilCertificateType"));
            app.setFullName(data.get("fullName"));
            app.setMobile(data.get("mobile"));
            app.setEmail(data.get("email"));
            app.setFatherName(data.get("fatherName"));
            app.setMotherName(data.get("motherName"));
            app.setDob(data.get("dob"));
            app.setGender(data.get("gender"));
            app.setDistrict(data.get("district"));
            app.setTaluk(data.get("taluk"));
            app.setAddress(data.get("address"));
            app.setAppliedDate(data.get("appliedDate"));
            app.setStatus(data.get("status"));

            // -----------------------------------------------------------
            // 3️⃣ STORE ONLY FILE NAME IN DB
            // -----------------------------------------------------------
            app.setAadhaar(fileName);

            // -----------------------------------------------------------
            // 4️⃣ SAVE APPLICATION TO DATABASE
            // -----------------------------------------------------------
            return service.apply(app);

        } catch (Exception e) {
            e.printStackTrace();
            throw new RuntimeException("Application submission error: " + e.getMessage());
        }
    }

    // ⭐ TRACK APPLICATION BY EMAIL
    @GetMapping("/track/email/{email}")
    public List<ApplicationModel> getByEmail(@PathVariable String email) {
        return service.getByEmail(email);
    }

    // ⭐ ADMIN — VIEW ALL
    @GetMapping("/admin")
    public List<ApplicationModel> getAll() {
        return service.getAllApplications();
    }

    // ⭐ UPDATE APPLICATION STATUS
    @PutMapping("/status/{id}")
    public ApplicationModel updateStatus(
            @PathVariable Long id,
            @RequestParam String status) {
        return service.updateStatus(id, status);
    }

    // ⭐ GET SINGLE APP BY ID
    @GetMapping("/{id}")
    public ApplicationModel getById(@PathVariable Long id) {
        return service.getById(id);
    }

    // ⭐ DELETE APPLICATION
    @DeleteMapping("/delete/{id}")
    public String deleteApplication(@PathVariable Long id) {
        boolean deleted = service.delete(id);
        return deleted ? "Application Deleted Successfully" : "Application Not Found";
    }
}
